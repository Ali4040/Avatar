<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Caucus Simulator — Parallel Bilateral Talks</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #0b1220;
        --panel: #0f1628;
        --ink: #e7eef8;
        --muted: #9fb3c8;
        --line: #1c2540;
        --glow: 0 18px 48px rgba(46, 134, 222, 0.18);
        --pres: #38bdf8;
        --safety: #f59e0b;
        --mobility: #3b82f6;
        --finance: #22c55e;
        --heritage: #a78bfa;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        width: 100%;
      }
      body {
        margin: 0;
        color: var(--ink);
        overflow-x: hidden;
        background: radial-gradient(
            900px 600px at -10% -20%,
            rgba(56, 189, 248, 0.12),
            transparent 60%
          ),
          radial-gradient(
            900px 600px at 110% -10%,
            rgba(124, 58, 237, 0.1),
            transparent 55%
          ),
          var(--bg);
        font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI",
          Roboto, Arial;
      }

      /* Full-width stage/grid */
      main.stage {
        width: 100%;
        margin: 0;
        padding: 0;
      }
      .grid {
        display: grid;
        gap: 20px;
        grid-template-columns: repeat(2, 1fr);
        align-items: start;
        justify-content: stretch;
        padding: 0 12px;
      }
      @media (max-width: 1200px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }

      /* Room */
      .room {
        border: 1px solid var(--line);
        border-radius: 18px;
        background: rgba(15, 22, 40, 0.74);
        box-shadow: var(--glow);
        overflow: hidden;
        display: grid;
        grid-template-rows: auto auto 1fr;
        min-height: 560px;
        width: 100%;
      }
      .room .hdr {
        padding: 12px 16px;
        border-bottom: 1px solid var(--line);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .room .hdr .title {
        font-weight: 800;
        font-size: 15px;
      }
      .badge {
        font-size: 11px;
        color: #cfe3ff;
        background: #0d1426;
        border: 1px solid var(--line);
        padding: 4px 8px;
        border-radius: 999px;
      }

      /* Arena: avatars on top, bubble field below (dynamic) */
      .arena {
        position: relative;
        padding: 18px;
        min-height: 420px;
      }
      .halo {
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: radial-gradient(
            40% 40% at 50% 50%,
            rgba(59, 130, 246, 0.08),
            transparent 70%
          ),
          radial-gradient(
            25% 25% at 20% 20%,
            rgba(16, 185, 129, 0.06),
            transparent 65%
          );
        filter: blur(2px);
      }

      .actors {
        position: relative;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        z-index: 1;
        align-items: center;
        justify-items: center;
        min-height: 120px; /* ensures room for avatars row */
      }
      .actor {
        position: relative;
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: center;
        padding: 6px 0;
      }
      .ring {
        width: 78px;
        height: 78px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        box-shadow: 0 10px 28px rgba(0, 0, 0, 0.35);
      }
      .ring.pres {
        background: conic-gradient(
          from 0deg,
          var(--pres),
          #0ea5e9 40%,
          #1f2937 41% 100%
        );
      }
      .ring.safety {
        background: conic-gradient(
          from 0deg,
          var(--safety),
          #f97316 40%,
          #1f2937 41% 100%
        );
      }
      .ring.mobility {
        background: conic-gradient(
          from 0deg,
          var(--mobility),
          #2563eb 40%,
          #1f2937 41% 100%
        );
      }
      .ring.finance {
        background: conic-gradient(
          from 0deg,
          var(--finance),
          #16a34a 40%,
          #1f2937 41% 100%
        );
      }
      .ring.heritage {
        background: conic-gradient(
          from 0deg,
          var(--heritage),
          #7c3aed 40%,
          #1f2937 41% 100%
        );
      }
      .actor img {
        width: 66px;
        height: 66px;
        object-fit: cover;
        border-radius: 50%;
        border: 2px solid #0b1220;
      }
      .actor .label {
        position: absolute;
        bottom: -16px;
        background: #0f1a33;
        border: 1px solid var(--line);
        color: var(--ink);
        border-radius: 999px;
        padding: 3px 8px;
        font-size: 10.5px;
        box-shadow: var(--glow);
      }
      .actor.left .label {
        left: 50%;
        transform: translateX(-50%);
      }
      .actor.right .label {
        right: 50%;
        transform: translateX(50%);
      }

      /* Bubble field sits BELOW avatars; top is set per-room via CSS var */
      .bubbles {
        position: absolute;
        left: 0;
        right: 0;
        top: var(--bubbles-top, 140px);
        bottom: 0;
        z-index: 2;
        pointer-events: none;
      }

      .bubble {
        position: absolute;
        max-width: 64%;
        background: #0f1a33;
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 8px 10px;
        box-shadow: var(--glow);
        opacity: 0;
        transform: translateY(8px) scale(0.98);
        animation: enter 0.35s ease forwards;
      }
      .bubble .who {
        font-weight: 800;
        font-size: 12.5px;
        margin-bottom: 4px;
      }
      .bubble .text {
        font-size: 12.75px;
        line-height: 1.32;
        white-space: pre-wrap;
      }
      .bubble.left::after,
      .bubble.right::after {
        content: "";
        position: absolute;
        bottom: -8px;
        width: 12px;
        height: 12px;
        transform: rotate(45deg);
        background: #0f1a33;
        border-left: 1px solid var(--line);
        border-bottom: 1px solid var(--line);
      }
      .bubble.left {
        left: 14px;
      }
      .bubble.left::after {
        left: 28px;
      }
      .bubble.right {
        right: 14px;
      }
      .bubble.right::after {
        right: 28px;
      }

      .bubble.safety {
        outline: 2px solid rgba(245, 158, 11, 0.22);
      }
      .bubble.mobility {
        outline: 2px solid rgba(59, 130, 246, 0.22);
      }
      .bubble.finance {
        outline: 2px solid rgba(34, 197, 94, 0.22);
      }
      .bubble.heritage {
        outline: 2px solid rgba(167, 139, 250, 0.22);
      }
      .bubble.pres {
        outline: 2px solid rgba(56, 189, 248, 0.22);
      }

      /* Sliding window hide */
      .bubble.hide {
        opacity: 0 !important;
        transform: translateY(-10px) scale(0.98) !important;
        transition: opacity 0.28s ease, transform 0.28s ease;
        pointer-events: none;
      }

      @keyframes enter {
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      /* Transcript + synthesis */
      .transcript {
        border-top: 1px solid var(--line);
        padding: 10px 12px;
        background: rgba(15, 22, 40, 0.52);
        max-height: 180px;
        overflow: auto;
        overscroll-behavior: contain;
      }
      .trow {
        display: grid;
        grid-template-columns: 12ch 1fr;
        gap: 8px;
        margin: 6px 0;
      }
      .trow small {
        color: var(--muted);
      }

      .synthesis {
        grid-column: 1/-1;
        border: 1px solid var(--line);
        border-radius: 18px;
        background: rgba(15, 22, 40, 0.74);
        box-shadow: var(--glow);
        padding: 16px 20px;
        margin: 0 12px 16px;
      }
      .synthesis h3 {
        margin: 0 0 8px 0;
      }
      .checklist {
        display: grid;
        grid-template-columns: repeat(2, minmax(280px, 1fr));
        gap: 12px;
      }
      @media (max-width: 980px) {
        .checklist {
          grid-template-columns: 1fr;
        }
      }
      .card {
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 10px 12px;
        background: #0f1a33;
      }
      .card h4 {
        margin: 0 0 6px 0;
        font-size: 14px;
      }
      .ok {
        color: #22c55e;
        font-weight: 800;
        margin-left: 6px;
      }
      .small {
        color: var(--muted);
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <main class="stage">
      <section class="grid" id="grid"></section>

      <section class="synthesis" id="synthesis">
        <h3>Amended Package — Live Synthesis</h3>
        <div class="checklist">
          <div class="card" id="syn-safety">
            <h4>Safety <span class="ok" hidden>✔</span></h4>
            <ul class="small" id="syn-safety-list">
              <li>Waiting for caucus outcome…</li>
            </ul>
          </div>
          <div class="card" id="syn-mobility">
            <h4>Mobility <span class="ok" hidden>✔</span></h4>
            <ul class="small" id="syn-mobility-list">
              <li>Waiting for caucus outcome…</li>
            </ul>
          </div>
          <div class="card" id="syn-finance">
            <h4>Finance <span class="ok" hidden>✔</span></h4>
            <ul class="small" id="syn-finance-list">
              <li>Waiting for caucus outcome…</li>
            </ul>
          </div>
          <div class="card" id="syn-heritage">
            <h4>Heritage & Environment <span class="ok" hidden>✔</span></h4>
            <ul class="small" id="syn-heritage-list">
              <li>Waiting for caucus outcome…</li>
            </ul>
          </div>
        </div>
      </section>
    </main>

    <script>
      const ACTOR = {
        PRESIDENT: {
          name: "President",
          avatar: "PRESIDENT.png",
          className: "pres",
        },
        SAFETY: {
          name: "Safety Bloc",
          avatar: "SAFETY.png",
          className: "safety",
        },
        MOBILITY: {
          name: "Mobility Bloc",
          avatar: "MOBILITY.png",
          className: "mobility",
        },
        FINANCE: {
          name: "Finance Bloc",
          avatar: "FINANCE.png",
          className: "finance",
        },
        HERITAGE: {
          name: "Heritage/Environment Bloc",
          avatar: "HERITAGE.png",
          className: "heritage",
        },
      };

      const SCRIPTS = [
        {
          id: "room-safety",
          title: "Caucus — President ↔ Safety Bloc",
          left: ACTOR.PRESIDENT,
          right: ACTOR.SAFETY,
          conditions: [
            "D−30 full-scale tests before each phase",
            "Automatic stop if vibration exceeds critical threshold",
            "Marked emergency lanes from preparation stage",
          ],
          messages: [
            {
              who: "Safety Bloc",
              side: "right",
              cls: "safety",
              text: "Madam President, we cannot accept Circular+ as it stands. The risk is too high. Imagine a major accident and delayed emergency response — we would be exposed legally and politically.",
            },
            {
              who: "President",
              side: "left",
              cls: "pres",
              text: "What would need to be added to Circular+ for you to accept it?",
            },
            {
              who: "Safety Bloc",
              side: "right",
              cls: "safety",
              text: "Three conditions: (1) Mandatory tests 30 days before each work phase, (2) an automatic stop mechanism if vibrations exceed the critical threshold, (3) marked emergency lanes from the preparatory stage. Without this, we stick to Security+.",
            },
            {
              who: "President",
              side: "left",
              cls: "pres",
              text: "If we include these conditions in the amended package and make them contractual, will you drop Security+?",
            },
            {
              who: "Safety Bloc",
              side: "right",
              cls: "safety",
              text: "Yes — provided it is legally binding.",
              accept: true,
            },
          ],
        },
        {
          id: "room-mobility",
          title: "Caucus — President ↔ Mobility Bloc",
          left: ACTOR.PRESIDENT,
          right: ACTOR.MOBILITY,
          conditions: [
            "≥80% of works at night on sensitive axes",
            "Fixed delivery slots: 6–11 a.m. and 2–4 p.m.",
            "Financial penalties for schedule/noise breaches",
            "Sunset clause: Sunday mornings limited to 6 months, renewable only if objectives are met",
          ],
          messages: [
            {
              who: "Mobility Bloc",
              side: "right",
              cls: "mobility",
              text: "Flow+ is our choice, but it lacks support. If we must accept Circular+, we need rock-solid guarantees; otherwise residents and shopkeepers will crush us.",
            },
            {
              who: "President",
              side: "left",
              cls: "pres",
              text: "What precise guarantees?",
            },
            {
              who: "Mobility Bloc",
              side: "right",
              cls: "mobility",
              text: "Three things: (1) at least 80% of works at night on sensitive axes; (2) fixed delivery windows — 6–11 a.m. and 2–4 p.m.; (3) financial penalties if schedules or the noise plan are not respected. And a sunset clause: if Sunday morning works are decided, they are limited to 6 months, renewable only if objectives are met.",
            },
            {
              who: "President",
              side: "left",
              cls: "pres",
              text: "Very well. If we add all this to the amended package, will you accept Circular+?",
            },
            {
              who: "Mobility Bloc",
              side: "right",
              cls: "mobility",
              text: "Yes — under those conditions we can defend the decision before users.",
              accept: true,
            },
          ],
        },
        {
          id: "room-finance",
          title: "Caucus — President ↔ Finance Bloc",
          left: ACTOR.PRESIDENT,
          right: ACTOR.FINANCE,
          conditions: [
            "±2% yearly tolerance, compensated the following year",
            "No twin budget peaks",
            "Monthly publication of spending",
          ],
          messages: [
            {
              who: "Finance Bloc",
              side: "right",
              cls: "finance",
              text: "We support Circular+, but we fear a 'peaks and valleys' effect — a budget explosion in Year 2 then a drop in Year 3. That would cause a media scandal.",
            },
            {
              who: "President",
              side: "left",
              cls: "pres",
              text: "What is your proposal?",
            },
            {
              who: "Finance Bloc",
              side: "right",
              cls: "finance",
              text: "A ±2% tolerance in one year, but only if compensated the next year. No twin peaks. And monthly spending must be published to ensure transparency.",
            },
            {
              who: "President",
              side: "left",
              cls: "pres",
              text: "If we add this, will you accept the amended Circular+?",
            },
            {
              who: "Finance Bloc",
              side: "right",
              cls: "finance",
              text: "Yes — under those conditions.",
              accept: true,
            },
          ],
        },
        {
          id: "room-heritage",
          title: "Caucus — President ↔ Heritage & Environment Bloc",
          left: ACTOR.PRESIDENT,
          right: ACTOR.HERITAGE,
          conditions: [
            "Reversible interventions on Stone Bridge",
            "Never two river works in the same season",
          ],
          messages: [
            {
              who: "Heritage/Environment Bloc",
              side: "right",
              cls: "heritage",
              text: "We want Circular+, but two conditions are non-negotiable: (1) all interventions on Stone Bridge must be reversible; (2) there must never be two river works in the same season.",
            },
            {
              who: "President",
              side: "left",
              cls: "pres",
              text: "If we write these guarantees, do you validate?",
            },
            {
              who: "Heritage/Environment Bloc",
              side: "right",
              cls: "heritage",
              text: "Yes.",
              accept: true,
            },
          ],
        },
      ];

      const grid = document.getElementById("grid");
      const rooms = new Map();

      function mk(tag, cls, txt) {
        const el = document.createElement(tag);
        if (cls) el.className = cls;
        if (txt) el.textContent = txt;
        return el;
      }

      function buildRoom(spec) {
        const root = mk("section", "room");
        root.id = spec.id;

        const hdr = mk("div", "hdr");
        const title = mk("div", "title", spec.title);
        const badge = mk("div", "badge", "Bilateral caucus");
        hdr.appendChild(title);
        hdr.appendChild(badge);

        const arena = mk("div", "arena");
        const halo = mk("div", "halo");
        arena.appendChild(halo);
        const actors = mk("div", "actors");

        const left = mk("div", "actor left");
        const leftRing = mk("div", "ring pres");
        const leftImg = new Image();
        leftImg.src = spec.left.avatar;
        leftImg.alt = spec.left.name;
        leftRing.appendChild(leftImg);
        left.appendChild(leftRing);
        const leftLbl = mk("div", "label", spec.left.name);
        left.appendChild(leftLbl);

        const right = mk("div", "actor right");
        const rightRing = mk("div", "ring " + spec.right.className);
        const rightImg = new Image();
        rightImg.src = spec.right.avatar;
        rightImg.alt = spec.right.name;
        rightRing.appendChild(rightImg);
        right.appendChild(rightRing);
        const rightLbl = mk("div", "label", spec.right.name);
        right.appendChild(rightLbl);

        actors.appendChild(left);
        actors.appendChild(right);
        arena.appendChild(actors);

        const bubbles = mk("div", "bubbles"); // top will be set dynamically per room
        arena.appendChild(bubbles);

        const transcript = mk("div", "transcript");

        root.appendChild(hdr);
        root.appendChild(arena);
        root.appendChild(transcript);
        grid.appendChild(root);

        const state = {
          spec,
          root,
          arena,
          actors,
          bubbles,
          transcript,
          idx: 0,
          playing: false,
          timer: null,
          done: false,
          visible: [], // sliding window of 2 visible bubbles
        };

        // set bubble field top just below avatars (dynamic)
        function setBubblesTop() {
          const h = state.actors.offsetHeight || 120;
          state.bubbles.style.setProperty("--bubbles-top", h + 12 + "px");
        }
        setBubblesTop();
        new ResizeObserver(setBubblesTop).observe(state.actors);

        rooms.set(spec.id, state);
      }

      SCRIPTS.forEach(buildRoom);

      function delayFor(text) {
        const base = 750,
          perChar = 22,
          max = 2300;
        const len = Math.min(text.length, 180);
        const raw = base + perChar * len;
        return Math.max(380, Math.min(max, raw));
      }

      function repositionVisible(state) {
        // Slots INSIDE the .bubbles area (already placed under avatars)
        const TOPS = [8, 96];
        state.visible.forEach((el, i) => {
          el.style.top = (TOPS[i] || 8) + "px";
        });
      }

      function pushBubble(state, msg) {
        const b = mk("div", "bubble " + msg.side + " " + msg.cls);
        const who = mk("div", "who", msg.who);
        const txt = mk("div", "text", msg.text);
        b.appendChild(who);
        b.appendChild(txt);

        if (state.visible.length >= 2) {
          const oldest = state.visible.shift();
          oldest.classList.add("hide");
          setTimeout(() => {
            oldest.style.display = "none";
          }, 300);
        }
        state.bubbles.appendChild(b);
        state.visible.push(b);
        repositionVisible(state);

        const row = mk("div", "trow");
        const wh = document.createElement("small");
        wh.textContent = msg.who;
        const tx = mk("div", null, msg.text);
        row.appendChild(wh);
        row.appendChild(tx);
        state.transcript.appendChild(row);
        state.transcript.scrollTo({
          top: state.transcript.scrollHeight,
          behavior: "smooth",
        });
      }

      const syn = {
        safety: {
          box: document.getElementById("syn-safety"),
          list: document.getElementById("syn-safety-list"),
        },
        mobility: {
          box: document.getElementById("syn-mobility"),
          list: document.getElementById("syn-mobility-list"),
        },
        finance: {
          box: document.getElementById("syn-finance"),
          list: document.getElementById("syn-finance-list"),
        },
        heritage: {
          box: document.getElementById("syn-heritage"),
          list: document.getElementById("syn-heritage-list"),
        },
      };
      function markAccepted(kind, items) {
        const s = syn[kind];
        s.list.innerHTML = "";
        items.forEach((t) => {
          const li = document.createElement("li");
          li.textContent = t;
          s.list.appendChild(li);
        });
        s.box.querySelector(".ok").hidden = false;
      }

      const BUCKET = {
        "room-safety": "safety",
        "room-mobility": "mobility",
        "room-finance": "finance",
        "room-heritage": "heritage",
      };

      function stepRoom(state) {
        if (state.done) return;
        const spec = state.spec;
        if (state.idx >= spec.messages.length) {
          state.done = true;
          state.playing = false;
          const bucket = BUCKET[spec.id];
          if (bucket) markAccepted(bucket, spec.conditions);
          return;
        }
        const msg = spec.messages[state.idx];
        pushBubble(state, msg);
        state.idx++;

        if (msg.accept) {
          const bucket = BUCKET[spec.id];
          if (bucket) markAccepted(bucket, spec.conditions);
        }

        if (state.playing) {
          clearTimeout(state.timer);
          state.timer = setTimeout(() => stepRoom(state), delayFor(msg.text));
        }
      }

      function runAll() {
        rooms.forEach((state) => {
          if (state.done) return;
          state.playing = true;
          clearTimeout(state.timer);
          const jitter = 120 + Math.random() * 180;
          state.timer = setTimeout(() => stepRoom(state), jitter);
        });
      }

      // Auto-start
      window.addEventListener("load", runAll);
    </script>
  </body>
</html>
